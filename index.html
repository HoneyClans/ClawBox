<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClawBox - ä½ çš„æœ¬åœ° AI åŠ©ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <div class="max-w-4xl mx-auto p-6 mt-10">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-blue-600 mb-2">ğŸ¦ ClawBox</h1>
            <p class="text-gray-500">0 Code æ–°æ‰‹å‹å¥½çš„æœ¬åœ° AI ä»£ç†æ§åˆ¶å°</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- å·¦å´ï¼šå®‰å…¨èˆ‡è¨­å®šé¢æ¿ -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">âš™ï¸ ç³»çµ±è¨­å®šèˆ‡å®‰å…¨æ¬Šé™</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">OpenAI API Key</label>
                    <input type="password" id="apiKey" class="w-full border-gray-300 rounded-lg p-2 border focus:ring-blue-500 focus:border-blue-500" placeholder="sk-...">
                </div>

                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">ğŸ›¡ï¸ AI æœ¬åœ°æ¬Šé™æ§åˆ¶ (é è¨­é—œé–‰)</h3>
                    <label class="flex items-center space-x-3 mb-2 cursor-pointer">
                        <input type="checkbox" id="allowFileRead" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="text-gray-700">å…è¨± AI è®€å–æœ¬åœ°ç³»çµ±è³‡è¨Š (å¦‚æ™‚é–“)</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer opacity-50">
                        <input type="checkbox" id="allowSystemCmd" disabled class="form-checkbox h-5 w-5 text-gray-400 rounded">
                        <span class="text-gray-500">å…è¨± AI åŸ·è¡Œç³»çµ±çµ‚ç«¯æ©ŸæŒ‡ä»¤ (é–‹ç™¼ä¸­)</span>
                    </label>
                </div>

                <button onclick="saveSettings()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    ğŸ’¾ å„²å­˜è¨­å®š
                </button>
                <p id="saveStatus" class="text-green-600 text-sm mt-2 hidden">è¨­å®šå·²å„²å­˜ï¼</p>
            </div>

            <!-- å³å´ï¼šAI æ¸¬è©¦å°è©±æ¡† -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col h-[500px]">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">ğŸ’¬ ä»£ç†æ¸¬è©¦çµ‚ç«¯</h2>
                
                <div id="chatBox" class="flex-1 overflow-y-auto bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200 space-y-3">
                    <div class="text-gray-500 text-sm text-center">æ­¡è¿ä½¿ç”¨ ClawBoxï¼è«‹å…ˆå„²å­˜ API Key å¾Œé–‹å§‹å°è©±ã€‚</div>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="chatInput" class="flex-1 border-gray-300 rounded-lg p-2 border focus:ring-blue-500 focus:border-blue-500" placeholder="è¼¸å…¥æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼šç¾åœ¨å¹¾é»ï¼Ÿ" onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button onclick="sendMessage()" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        ç™¼é€
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–è¼‰å…¥è¨­å®š
        fetch('/api/settings')
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                document.getElementById('apiKey').value = data.apiKey || '';
                document.getElementById('allowFileRead').checked = data.allowFileRead || false;
            })
            .catch(error => {
                console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
                const chatBox = document.getElementById('chatBox');
                if (chatBox) {
                    chatBox.innerHTML = `<div class="text-red-500 text-sm text-center">âš ï¸ ç„¡æ³•è¼‰å…¥è¨­å®šï¼š${error.message}</div>`;
                }
            });

        async function saveSettings() {
            const apiKey = document.getElementById('apiKey').value;
            const allowFileRead = document.getElementById('allowFileRead').checked;
            
            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, allowFileRead })
                });

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                const data = await res.json();
                const status = document.getElementById('saveStatus');
                if (status) {
                    status.textContent = data.message || 'è¨­å®šå·²å„²å­˜ï¼';
                    status.classList.remove('hidden');
                    setTimeout(() => status.classList.add('hidden'), 3000);
                }
            } catch (error) {
                console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
                const status = document.getElementById('saveStatus');
                if (status) {
                    status.textContent = `âŒ å„²å­˜å¤±æ•—ï¼š${error.message}`;
                    status.classList.remove('hidden');
                    status.classList.add('text-red-600');
                    setTimeout(() => {
                        status.classList.add('hidden');
                        status.classList.remove('text-red-600');
                    }, 5000);
                }
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const chatBox = document.getElementById('chatBox');
            if (!chatBox) return;

            // é¡¯ç¤ºç”¨æˆ¶æ¶ˆæ¯
            chatBox.innerHTML += `<div class="text-right"><span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg inline-block">${escapeHtml(message)}</span></div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            const loadingId = 'loading-' + Date.now();
            chatBox.innerHTML += `<div id="${loadingId}" class="text-left"><span class="text-gray-400 text-sm">AI æ€è€ƒä¸­...</span></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                const data = await res.json();

                // ç§»é™¤è¼‰å…¥ä¸­
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) {
                    loadingEl.remove();
                }

                // é¡¯ç¤º AI å›è¦†
                chatBox.innerHTML += `<div class="text-left"><span class="bg-gray-200 text-gray-800 px-3 py-1 rounded-lg inline-block whitespace-pre-wrap">${escapeHtml(data.reply || 'ç„¡å›è¦†')}</span></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                console.error('ç™¼é€æ¶ˆæ¯å¤±æ•—:', error);
                
                // ç§»é™¤è¼‰å…¥ä¸­
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) {
                    loadingEl.remove();
                }

                // é¡¯ç¤ºéŒ¯èª¤æ¶ˆæ¯
                chatBox.innerHTML += `<div class="text-left"><span class="bg-red-100 text-red-800 px-3 py-1 rounded-lg inline-block">âŒ è«‹æ±‚å¤±æ•—ï¼š${escapeHtml(error.message)}</span></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        // HTML è½‰ç¾©å‡½æ•¸ï¼Œé˜²æ­¢ XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>