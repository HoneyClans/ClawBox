<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenClaw - ä½ çš„æœ¬åœ° AI åŠ©ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tip-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <div class="max-w-6xl mx-auto p-6 mt-4">
        <header class="mb-6 text-center">
            <img src="/assets/GreenClaw_logo.png" alt="GreenClaw" class="mx-auto w-full max-w-md object-contain block" style="max-height: 180px;" onerror="this.style.display='none'">
            <p class="text-gray-500 mt-3 text-sm sm:text-base">0 Code æ–°æ‰‹å‹å¥½çš„æœ¬åœ° AI ä»£ç†æ§åˆ¶å°</p>
        </header>

        <!-- ç¬¬ä¸€æ€§åŸç†ï¼šä¸€å¥è©±æ‡‚ GreenClaw -->
        <div class="tip-card text-white p-4 rounded-lg mb-4 shadow-lg">
            <div class="flex items-start">
                <span class="text-2xl mr-3">ğŸ’¡</span>
                <div class="flex-1">
                    <h3 class="font-bold mb-1">ä¸€å¥è©±ææ‡‚ï¼š</h3>
                    <p class="text-sm mb-2">GreenClaw = åªè¦ä¸€å€‹ API Keyï¼Œå°±èƒ½åœ¨æœ¬åœ°ç”¨ç¶²é è·Ÿå„ç¨® AI èŠå¤©ã€ç”Ÿåœ–ã€æœå°‹ï¼Œ<strong>ä¸ç”¨å¯«ç¨‹å¼ã€ä¸ç”¨è£è¤‡é›œè»Ÿé«”</strong>ã€‚</p>
                    <h3 class="font-bold mb-1 mt-2">è¶…ç°¡å–®ä¸‰æ­¥é©Ÿï¼š</h3>
                    <ol class="text-sm space-y-1 list-decimal list-inside">
                        <li>å·¦é‚Šé¸ã€ŒAI æœå‹™ã€ï¼ˆOpenAI / Groq å…è²» / OpenRouter å¤šæ¨¡å‹ï¼‰</li>
                        <li>è¼¸å…¥å°æ‡‰çš„ API Keyï¼ŒæŒ‰ã€Œå„²å­˜è¨­å®šã€</li>
                        <li>åœ¨ã€Œå°è©±ã€åˆ†é æ‰“å­—ã€æˆ–åˆ°ã€Œåœ–ç‰‡ç”Ÿæˆã€ã€Œç¶²çµ¡æœç´¢ã€ã€Œç¤¾ç¾¤å°ç·¨ã€ç”¨å…¶ä»–åŠŸèƒ½</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- å¯æ”¶åˆï¼šä½¿ç”¨æ•™å­¸èˆ‡å°è²¼å£« -->
        <div class="bg-white border border-gray-200 rounded-xl mb-6 overflow-hidden">
            <button type="button" id="tipsToggleBtn" onclick="var c=document.getElementById('tipsContent'); c.classList.toggle('hidden'); this.querySelector('span').textContent=c.classList.contains('hidden')?'ğŸ“– å±•é–‹ä½¿ç”¨æ•™å­¸èˆ‡å°è²¼å£«':'ğŸ“– æ”¶åˆä½¿ç”¨æ•™å­¸èˆ‡å°è²¼å£«';" class="w-full text-left px-4 py-3 font-medium text-gray-700 hover:bg-gray-50 flex items-center justify-between">
                <span>ğŸ“– å±•é–‹ä½¿ç”¨æ•™å­¸èˆ‡å°è²¼å£«</span>
                <span class="text-gray-400 text-sm">é»æ“Šå±•é–‹/æ”¶åˆ</span>
            </button>
            <div id="tipsContent" class="hidden px-4 pb-4 border-t border-gray-100">
                <div class="pt-3 space-y-3 text-sm text-gray-600">
                    <p><strong>ğŸ¯ å°è©±ï¼š</strong>é¸å¥½æ¨¡å‹èˆ‡ Key å¾Œç›´æ¥è¼¸å…¥å•é¡Œã€‚è©¦è©¦ã€Œå¹«æˆ‘å¯« TikTok æ–‡æ¡ˆã€æˆ–ã€Œç”¨ä¸‰å¥è©±è§£é‡‹é‡å­ç³¾çºã€ã€‚</p>
                    <p><strong>ğŸ–¼ï¸ åœ–ç‰‡ç”Ÿæˆï¼š</strong>ç”¨ OpenAI çš„ DALL-Eï¼Œéœ€ OpenAI API Keyï¼ˆå¯èˆ‡å°è©±å…±ç”¨ï¼‰ã€‚æè¿°è¶Šå…·é«”ï¼Œåœ–è¶Šè²¼è¿‘æƒ³åƒã€‚</p>
                    <p><strong>ğŸŒ ç¶²çµ¡æœç´¢ï¼š</strong>éœ€ Bing Web Search API é‡‘é‘°ï¼Œåœ¨å·¦å´ã€Œåœ–ç‰‡èˆ‡æœç´¢ã€å¡«å¯«ã€‚å¯æ‰¾ç†±é–€è©±é¡Œã€æŸ¥è³‡æ–™ã€‚</p>
                    <p><strong>ğŸ¦ ç¤¾ç¾¤å°ç·¨ï¼š</strong>ä¸€éµç”Ÿæˆè²¼æ–‡æ–‡æ¡ˆã€é…åœ–æˆ–ç†±é–€è¶¨å‹¢ï¼Œé©åˆç™¼æƒ³éˆæ„Ÿã€‚</p>
                    <p class="text-amber-700 bg-amber-50 p-2 rounded"><strong>å°è²¼å£«ï¼š</strong>Groq èˆ‡ OpenRouter æœ‰å…è²»é¡åº¦ï¼›OpenRouter å¯é¸ Geminiã€Grokã€Claude ç­‰ï¼Œä¸€å€‹ Key ç”¨å¤šç¨®æ¨¡å‹ã€‚é‡åˆ° 401 è«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢ºã€æœ‰ç„¡å¤šé¤˜ç©ºæ ¼ã€‚</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦å´ï¼šè¨­å®šé¢æ¿ -->
            <div class="lg:col-span-1 space-y-6">
                <!-- API Provider å’Œ Model é¸æ“‡ -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">ğŸ¤– AI æ¨¡å‹è¨­å®š</h2>
                    <p class="text-xs text-gray-500 mb-3">ğŸ’¡ å¯é¸<strong>å®˜æ–¹ç›´é€£</strong>ï¼ˆOpenAI / Groq / xAI / Google / Anthropicï¼‰æˆ–<strong>OpenRouter</strong>ï¼ˆä¸€å€‹ Key ç”¨å¤šç¨®æ¨¡å‹ï¼‰ï¼›Groq æœ‰å…è²»é¡åº¦ã€‚</p>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡ AI æœå‹™</label>
                        <select id="apiProvider" onchange="updateModels()" class="w-full border-gray-300 rounded-lg p-2 border focus:ring-blue-500 focus:border-blue-500">
                            <!-- ç”± /api/settings å‹•æ…‹å¡«å…¥ï¼šOpenAIã€Groqã€xAIã€Googleã€Anthropic å®˜æ–¹ + OpenRouter -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1" id="providerHint">è¼‰å…¥ä¸­â€¦</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡æ¨¡å‹</label>
                        <select id="model" class="w-full border-gray-300 rounded-lg p-2 border focus:ring-blue-500 focus:border-blue-500">
                            <!-- å‹•æ…‹å¡«å…… -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1" id="modelHint">é¸æ“‡é©åˆä½ éœ€æ±‚çš„æ¨¡å‹</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                        <input type="password" id="apiKey" class="w-full border-gray-300 rounded-lg p-2 border focus:ring-blue-500 focus:border-blue-500" placeholder="sk-or-v1-... æˆ– gsk_...">
                        <div class="mt-2 text-xs text-gray-600 space-y-1">
                            <p><strong>Groq å…è²» Keyï¼š</strong> <a href="https://console.groq.com" target="_blank" class="text-blue-600 underline">console.groq.com</a></p>
                            <p><strong>OpenRouterï¼š</strong> <a href="https://openrouter.ai/keys" target="_blank" class="text-blue-600 underline">openrouter.ai/keys</a></p>
                            <p class="text-amber-700 bg-amber-50 px-2 py-1 rounded mt-1">âš ï¸ 401 æ™‚ï¼šè«‹åˆ° openrouter.ai/keys æŒ‰ Create æ–° Keyï¼Œå»ºç«‹æ™‚åªé¡¯ç¤ºä¸€æ¬¡ï¼Œè«‹å³æ™‚è¤‡è£½è²¼ä¸Šã€‚</p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">ğŸ›¡ï¸ å®‰å…¨æ¬Šé™ (é è¨­é—œé–‰)</h3>
                        <label class="flex items-center space-x-3 mb-2 cursor-pointer">
                            <input type="checkbox" id="allowFileRead" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                            <span class="text-gray-700 text-sm">å…è¨±è®€å–ç³»çµ±è³‡è¨Š</span>
                        </label>
                    </div>

                    <button onclick="saveSettings()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        ğŸ’¾ å„²å­˜è¨­å®š
                    </button>
                    <p id="saveStatus" class="text-green-600 text-sm mt-2 hidden text-center">è¨­å®šå·²å„²å­˜ï¼</p>
                </div>

                <!-- åœ–ç‰‡ / æœç´¢ API Key -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">ğŸ–¼ï¸ åœ–ç‰‡èˆ‡æœç´¢</h2>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">åœ–ç‰‡ç”Ÿæˆ (DALL-E)</label>
                        <input type="password" id="imageApiKey" class="w-full border-gray-300 rounded-lg p-2 border text-sm" placeholder="å¯ç•™ç©ºï¼Œå°‡ä½¿ç”¨ä¸Šæ–¹ AI Key (OpenAI)">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç¶²çµ¡æœç´¢ (Bing)</label>
                        <input type="password" id="searchApiKey" class="w-full border-gray-300 rounded-lg p-2 border text-sm" placeholder="Bing Web Search API è¨‚é–±é‡‘é‘°">
                        <p class="text-xs text-gray-500 mt-1"><a href="https://www.microsoft.com/en-us/bing/apis/bing-web-search-api" target="_blank" class="text-blue-600 underline">ç”³è«‹ Bing API</a></p>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šä¸»åŠŸèƒ½å€ï¼ˆåˆ†é ï¼‰ -->
            <div class="lg:col-span-2">
                <div class="flex gap-2 mb-4 border-b border-gray-200">
                    <button type="button" onclick="switchTab('chat')" id="tab-chat" class="tab-btn px-4 py-2 rounded-t-lg font-medium bg-blue-100 text-blue-800 border-b-2 border-blue-600">ğŸ’¬ å°è©±</button>
                    <button type="button" onclick="switchTab('image')" id="tab-image" class="tab-btn px-4 py-2 rounded-t-lg font-medium text-gray-600 hover:bg-gray-100">ğŸ–¼ï¸ åœ–ç‰‡ç”Ÿæˆ</button>
                    <button type="button" onclick="switchTab('search')" id="tab-search" class="tab-btn px-4 py-2 rounded-t-lg font-medium text-gray-600 hover:bg-gray-100">ğŸŒ ç¶²çµ¡æœç´¢</button>
                    <button type="button" onclick="switchTab('community')" id="tab-community" class="tab-btn px-4 py-2 rounded-t-lg font-medium text-gray-600 hover:bg-gray-100">ğŸ¦ ç¤¾ç¾¤å°ç·¨</button>
                </div>

                <!-- å°è©±é  -->
                <div id="panel-chat" class="tab-panel bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col h-[560px]">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">ğŸ’¬ AI å°è©±çµ‚ç«¯</h2>
                    <div id="chatBox" class="flex-1 overflow-y-auto bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200 space-y-3">
                        <div class="text-gray-500 text-sm text-center space-y-2">
                            <p>ğŸ‘‹ æ­¡è¿ä½¿ç”¨ GreenClawï¼</p>
                            <p>è«‹å…ˆåœ¨å·¦å´è¨­å®š API Keyï¼Œç„¶å¾Œé–‹å§‹å°è©±ã€‚</p>
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg text-left">
                                <p class="font-semibold text-blue-800 mb-1">ğŸ’¡ å°è²¼å£«ï¼š</p>
                                <ul class="text-xs text-blue-700 space-y-1 list-disc list-inside">
                                    <li>è©¦è©¦å•ï¼šã€Œå¹«æˆ‘å¯«ä¸€æ®µ TikTok æ–‡æ¡ˆã€</li>
                                    <li>æˆ–ï¼šã€Œåˆ†æä¸€ä¸‹æœ€è¿‘ç†±é–€è©±é¡Œã€</li>
                                    <li>Groq å…è²»ä¸”é€Ÿåº¦è¶…å¿«ï¼Œæ¨è–¦æ–°æ‰‹ä½¿ç”¨ï¼</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="chatInput" class="flex-1 border-gray-300 rounded-lg p-2 border focus:ring-blue-500 focus:border-blue-500" placeholder="è¼¸å…¥ä½ çš„å•é¡Œæˆ–æŒ‡ä»¤..." onkeypress="if(event.key === 'Enter') sendMessage()">
                        <button onclick="sendMessage()" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-4 rounded-lg transition duration-200">ç™¼é€</button>
                    </div>
                </div>

                <!-- åœ–ç‰‡ç”Ÿæˆé  -->
                <div id="panel-image" class="tab-panel hidden bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col h-[560px]">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">ğŸ–¼ï¸ AI åœ–ç‰‡ç”Ÿæˆ</h2>
                    <p class="text-sm text-gray-500 mb-2">ä½¿ç”¨ DALL-E ç”Ÿæˆåœ–ç‰‡ï¼Œè«‹åœ¨å·¦å´ã€Œåœ–ç‰‡èˆ‡æœç´¢ã€æˆ– AI è¨­å®šå¡«å…¥ OpenAI API Keyã€‚</p>
                    <p class="text-xs text-blue-600 mb-3">ğŸ’¡ å°è²¼å£«ï¼šæè¿°è¶Šå…·é«”è¶Šå¥½ï¼Œä¾‹å¦‚ã€Œä¸€éš»ç©¿è¥¿è£çš„é¾è¦åœ¨è¾¦å…¬å®¤é–‹æœƒï¼Œå¡é€šé¢¨æ ¼ã€ã€‚</p>
                    <div class="mb-4 flex flex-wrap gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡å‹</label>
                            <select id="imageModel" class="w-full border rounded-lg p-2" onchange="updateImageSizes()"><option value="dall-e-3">DALL-E 3</option><option value="dall-e-2">DALL-E 2</option></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-700 mb-1">å°ºå¯¸</label>
                            <select id="imageSize" class="w-full border rounded-lg p-2"><option value="1024x1024">1024Ã—1024</option><option value="1024x1792">1024Ã—1792</option><option value="1792x1024">1792Ã—1024</option></select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">åœ–ç‰‡æè¿°</label>
                        <textarea id="imagePrompt" class="w-full border rounded-lg p-2 h-24" placeholder="ä¾‹ï¼šä¸€éš»ç©¿è¥¿è£çš„é¾è¦åœ¨è¾¦å…¬å®¤é–‹æœƒ"></textarea>
                    </div>
                    <button type="button" onclick="generateImage()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg mb-4">ç”Ÿæˆåœ–ç‰‡</button>
                    <div id="imageResult" class="flex-1 min-h-[200px] bg-gray-50 rounded-lg border border-gray-200 p-4 flex items-center justify-center text-gray-500 text-sm">ç”Ÿæˆçµæœå°‡é¡¯ç¤ºæ–¼æ­¤</div>
                </div>

                <!-- ç¶²çµ¡æœç´¢é  -->
                <div id="panel-search" class="tab-panel hidden bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col h-[560px]">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">ğŸŒ ç¶²çµ¡æœç´¢</h2>
                    <p class="text-sm text-gray-500 mb-2">ä½¿ç”¨ Bing API æœå°‹ï¼Œè«‹åœ¨å·¦å´ã€Œåœ–ç‰‡èˆ‡æœç´¢ã€å¡«å…¥ Bing Web Search API é‡‘é‘°ã€‚</p>
                    <p class="text-xs text-blue-600 mb-3">ğŸ’¡ å°è²¼å£«ï¼šå¯æœç†±é–€é—œéµå­—ç•¶ä½œç¤¾ç¾¤éˆæ„Ÿï¼Œæˆ–æŸ¥è³‡æ–™å¾Œå†å›ã€Œå°è©±ã€åˆ†é è«‹ AI æ•´ç†ã€‚</p>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="searchQuery" class="flex-1 border rounded-lg p-2" placeholder="è¼¸å…¥æœå°‹é—œéµå­—..." onkeypress="if(event.key==='Enter') doSearch()">
                        <button type="button" onclick="doSearch()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">æœå°‹</button>
                    </div>
                    <div id="searchResults" class="flex-1 overflow-y-auto space-y-3 text-sm">æœå°‹çµæœå°‡é¡¯ç¤ºæ–¼æ­¤</div>
                </div>

                <!-- ç¤¾ç¾¤å°ç·¨é  -->
                <div id="panel-community" class="tab-panel hidden bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col h-[560px]">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">ğŸ¦ ç¤¾ç¾¤å°ç·¨æ¨¡å¼</h2>
                    <p class="text-sm text-gray-500 mb-2">ä¸€éµç”Ÿæˆæ–‡æ¡ˆã€é…åœ–èˆ‡ç†±é–€è©±é¡Œéˆæ„Ÿï¼Œä¸ç”¨è‡ªå·±æƒ³æ¢—ã€‚</p>
                    <p class="text-xs text-blue-600 mb-4">ğŸ’¡ å°è²¼å£«ï¼šå…ˆå¡«ã€Œä¸»é¡Œã€å†æŒ‰ã€Œç”Ÿæˆè²¼æ–‡ã€ï¼›é…åœ–éœ€ OpenAI Keyï¼›ã€Œç†±é–€è¶¨å‹¢ã€æœƒç”¨æœå°‹çµæœå¹«ä½ æ‰¾éˆæ„Ÿã€‚</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="border border-gray-200 rounded-xl p-4 bg-blue-50">
                            <h3 class="font-semibold text-blue-800 mb-2">ğŸ“ ç”Ÿæˆæ–‡æ¡ˆ</h3>
                            <input type="text" id="communityTopic" class="w-full border rounded-lg p-2 mb-2 text-sm" placeholder="ä¸»é¡Œï¼Œä¾‹ï¼šæ–°å“ä¸Šå¸‚">
                            <button type="button" onclick="communityCopy()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm">ç”Ÿæˆè²¼æ–‡</button>
                        </div>
                        <div class="border border-gray-200 rounded-xl p-4 bg-purple-50">
                            <h3 class="font-semibold text-purple-800 mb-2">ğŸ–¼ï¸ ç”Ÿæˆé…åœ–</h3>
                            <input type="text" id="communityImagePrompt" class="w-full border rounded-lg p-2 mb-2 text-sm" placeholder="åœ–ç‰‡æè¿°">
                            <button type="button" onclick="communityImage()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg text-sm">ç”Ÿæˆåœ–ç‰‡</button>
                        </div>
                        <div class="border border-gray-200 rounded-xl p-4 bg-green-50">
                            <h3 class="font-semibold text-green-800 mb-2">ğŸ”¥ ç†±é–€è©±é¡Œ</h3>
                            <button type="button" onclick="communityTrending()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm">æœå°‹ç†±é–€è¶¨å‹¢</button>
                        </div>
                    </div>
                    <div id="communityOutput" class="flex-1 overflow-y-auto bg-gray-50 rounded-lg border border-gray-200 p-4 text-sm whitespace-pre-wrap">è¼¸å‡ºå°‡é¡¯ç¤ºæ–¼æ­¤</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let apiProviders = {};
        let currentProvider = 'openai';

        // è¼‰å…¥è¨­å®šå’Œ Providers
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                
                apiProviders = data.apiProviders || {};
                currentProvider = data.apiProvider || 'openai';
                
                // ä¾ API å›å‚³çš„ provider æ¸…å–®å‹•æ…‹å¡«å¯«ã€Œé¸æ“‡ AI æœå‹™ã€ä¸‹æ‹‰ï¼ˆä¿ç•™é †åºï¼šå®˜æ–¹å…ˆï¼Œå† OpenRouterï¼‰
                const providerSelect = document.getElementById('apiProvider');
                const providerKeys = Object.keys(apiProviders);
                providerSelect.innerHTML = providerKeys.map(k => '<option value="' + k + '">' + (apiProviders[k].name || k) + '</option>').join('');
                if (providerKeys.includes(currentProvider)) {
                    providerSelect.value = currentProvider;
                } else if (providerKeys.length) {
                    providerSelect.value = providerKeys[0];
                    currentProvider = providerKeys[0];
                }
                document.getElementById('apiKey').value = data.apiKey || '';
                document.getElementById('allowFileRead').checked = data.allowFileRead || false;
                if (document.getElementById('imageApiKey')) document.getElementById('imageApiKey').value = data.imageApiKey || '';
                if (document.getElementById('searchApiKey')) document.getElementById('searchApiKey').value = data.searchApiKey || '';
                
                updateModels();
                if (data.model) {
                    document.getElementById('model').value = data.model;
                }
            } catch (error) {
                console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
            }
        }

        // æ›´æ–°æ¨¡å‹åˆ—è¡¨
        function updateModels() {
            const provider = document.getElementById('apiProvider').value;
            currentProvider = provider;
            const providerData = apiProviders[provider] || { models: [] };
            const modelSelect = document.getElementById('model');
            
            // æ¸…ç©ºä¸¦å¡«å……æ¨¡å‹é¸é …
            modelSelect.innerHTML = '';
            providerData.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                if (model === providerData.defaultModel) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });

            // æ›´æ–°æç¤ºï¼ˆå®˜æ–¹ç›´é€£ vs èšåˆï¼‰
            const hints = {
                openai: 'OpenAI å®˜æ–¹ç›´é€£ï¼Œéœ€ OpenAI API Key',
                groq: 'Groq å®˜æ–¹ãƒ»å…è²»é¡åº¦ãƒ»é€Ÿåº¦å¿«',
                xai: 'xAI Grok å®˜æ–¹ç›´é€£ï¼Œéœ€ xAI API Keyï¼ˆconsole.x.aiï¼‰',
                google: 'Google Gemini å®˜æ–¹ç›´é€£ï¼Œéœ€ Google AI Studio API Key',
                anthropic: 'Anthropic Claude å®˜æ–¹ç›´é€£ï¼Œéœ€ Anthropic API Key',
                openrouter: 'ä¸€å€‹ Key ç”¨ç›¡å¤šç¨®æ¨¡å‹ï¼ˆGeminiã€Grokã€GPTã€Claude ç­‰ï¼‰ï¼Œå«å…è²»'
            };
            document.getElementById('providerHint').textContent = hints[provider] || 'é¸æ“‡æ¨¡å‹å¾Œå„²å­˜è¨­å®šå³å¯ä½¿ç”¨';
        }

        // å„²å­˜è¨­å®š
        async function saveSettings() {
            const apiKey = document.getElementById('apiKey').value;
            const apiProvider = document.getElementById('apiProvider').value;
            const model = document.getElementById('model').value;
            const allowFileRead = document.getElementById('allowFileRead').checked;
            const imageApiKey = document.getElementById('imageApiKey') ? document.getElementById('imageApiKey').value : '';
            const searchApiKey = document.getElementById('searchApiKey') ? document.getElementById('searchApiKey').value : '';
            
            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, apiProvider, model, allowFileRead, imageApiKey, searchApiKey })
                });

                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

                const data = await res.json();
                const status = document.getElementById('saveStatus');
                if (status) {
                    status.textContent = data.message || 'è¨­å®šå·²å„²å­˜ï¼';
                    status.classList.remove('hidden');
                    setTimeout(() => status.classList.add('hidden'), 3000);
                }
            } catch (error) {
                console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
                const status = document.getElementById('saveStatus');
                if (status) {
                    status.textContent = `âŒ å„²å­˜å¤±æ•—ï¼š${error.message}`;
                    status.classList.remove('hidden');
                    status.classList.add('text-red-600');
                    setTimeout(() => {
                        status.classList.add('hidden');
                        status.classList.remove('text-red-600');
                    }, 5000);
                }
            }
        }

        // ç™¼é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const chatBox = document.getElementById('chatBox');
            if (!chatBox) return;

            // é¡¯ç¤ºç”¨æˆ¶æ¶ˆæ¯
            chatBox.innerHTML += `<div class="text-right"><span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg inline-block">${escapeHtml(message)}</span></div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            const loadingId = 'loading-' + Date.now();
            chatBox.innerHTML += `<div id="${loadingId}" class="text-left"><span class="text-gray-400 text-sm">ğŸ¤” AI æ€è€ƒä¸­...</span></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await res.json().catch(() => ({}));

                // ç§»é™¤è¼‰å…¥ä¸­
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();

                if (!res.ok) {
                    // é¡¯ç¤ºå¾Œç«¯å›å‚³çš„éŒ¯èª¤è¨Šæ¯ï¼ˆä¾‹å¦‚ OpenRouter API éŒ¯èª¤ï¼‰
                    const errMsg = data.reply || `HTTP éŒ¯èª¤ï¼š${res.status}`;
                    chatBox.innerHTML += `<div class="text-left"><span class="bg-red-100 text-red-800 px-3 py-1 rounded-lg inline-block whitespace-pre-wrap">${escapeHtml(errMsg)}</span></div>`;
                    chatBox.scrollTop = chatBox.scrollHeight;
                    return;
                }

                // é¡¯ç¤º AI å›è¦†
                chatBox.innerHTML += `<div class="text-left"><span class="bg-gray-200 text-gray-800 px-3 py-1 rounded-lg inline-block whitespace-pre-wrap">${escapeHtml(data.reply || 'ç„¡å›è¦†')}</span></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                console.error('ç™¼é€æ¶ˆæ¯å¤±æ•—:', error);
                
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();

                chatBox.innerHTML += `<div class="text-left"><span class="bg-red-100 text-red-800 px-3 py-1 rounded-lg inline-block">âŒ è«‹æ±‚å¤±æ•—ï¼š${escapeHtml(error.message)}</span></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        // HTML è½‰ç¾©å‡½æ•¸
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆ†é åˆ‡æ›
        function switchTab(name) {
            ['chat','image','search','community'].forEach(t => {
                const panel = document.getElementById('panel-' + t);
                const tab = document.getElementById('tab-' + t);
                if (panel) panel.classList.toggle('hidden', t !== name);
                if (tab) {
                    tab.classList.toggle('bg-blue-100', t === name);
                    tab.classList.toggle('text-blue-800', t === name);
                    tab.classList.toggle('border-b-2', t === name);
                    tab.classList.toggle('border-blue-600', t === name);
                    tab.classList.toggle('text-gray-600', t !== name);
                }
            });
        }

        function updateImageSizes() {
            const model = document.getElementById('imageModel')?.value || 'dall-e-3';
            const sel = document.getElementById('imageSize');
            if (!sel) return;
            const options = model === 'dall-e-2' ? [['256x256','256Ã—256'],['512x512','512Ã—512'],['1024x1024','1024Ã—1024']] : [['1024x1024','1024Ã—1024'],['1024x1792','1024Ã—1792'],['1792x1024','1792Ã—1024']];
            sel.innerHTML = options.map(([v,l]) => '<option value="' + v + '">' + l + '</option>').join('');
        }

        // åœ–ç‰‡ç”Ÿæˆ
        async function generateImage() {
            const prompt = document.getElementById('imagePrompt')?.value?.trim();
            const resultEl = document.getElementById('imageResult');
            if (!prompt) { resultEl.innerHTML = '<span class="text-red-600">è«‹è¼¸å…¥åœ–ç‰‡æè¿°</span>'; return; }
            resultEl.innerHTML = '<span class="text-gray-500">ç”Ÿæˆä¸­â€¦</span>';
            try {
                const model = document.getElementById('imageModel')?.value || 'dall-e-3';
                const size = document.getElementById('imageSize')?.value || '1024x1024';
                const res = await fetch('/api/image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, model, size }) });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    resultEl.innerHTML = '<span class="text-red-600">' + escapeHtml(data.error || 'ç”Ÿæˆå¤±æ•—') + '</span>';
                    return;
                }
                resultEl.innerHTML = '<img src="' + escapeHtml(data.url) + '" alt="Generated" class="max-w-full rounded-lg shadow">' + (data.revised_prompt ? '<p class="mt-2 text-xs text-gray-500">' + escapeHtml(data.revised_prompt) + '</p>' : '');
            } catch (e) {
                resultEl.innerHTML = '<span class="text-red-600">' + escapeHtml(e.message) + '</span>';
            }
        }

        // ç¶²çµ¡æœç´¢
        async function doSearch() {
            const query = document.getElementById('searchQuery')?.value?.trim();
            const resultEl = document.getElementById('searchResults');
            if (!query) { resultEl.innerHTML = '<span class="text-gray-500">è«‹è¼¸å…¥é—œéµå­—</span>'; return; }
            resultEl.innerHTML = '<span class="text-gray-500">æœå°‹ä¸­â€¦</span>';
            try {
                const res = await fetch('/api/search', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    resultEl.innerHTML = '<span class="text-red-600">' + escapeHtml(data.error || 'æœå°‹å¤±æ•—') + '</span>';
                    return;
                }
                const list = (data.results || []).map(r => '<div class="border-b border-gray-200 pb-2"><a href="' + escapeHtml(r.url) + '" target="_blank" class="font-medium text-blue-600">' + escapeHtml(r.title) + '</a><p class="text-gray-600 mt-1">' + escapeHtml(r.snippet || '') + '</p></div>').join('') || '<span class="text-gray-500">ç„¡çµæœ</span>';
                resultEl.innerHTML = list;
            } catch (e) {
                resultEl.innerHTML = '<span class="text-red-600">' + escapeHtml(e.message) + '</span>';
            }
        }

        // ç¤¾ç¾¤å°ç·¨ï¼šç”Ÿæˆæ–‡æ¡ˆ
        async function communityCopy() {
            const topic = document.getElementById('communityTopic')?.value?.trim() || 'ç”¢å“æ¨å»£';
            const out = document.getElementById('communityOutput');
            out.textContent = 'ç”Ÿæˆæ–‡æ¡ˆä¸­â€¦';
            try {
                const res = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: 'è«‹å¹«æˆ‘å¯«ä¸€æ®µé©åˆç¤¾ç¾¤åª’é«”ï¼ˆå¦‚ FB/IGï¼‰çš„è²¼æ–‡æ–‡æ¡ˆï¼Œä¸»é¡Œï¼š' + topic + 'ã€‚è¦ç°¡çŸ­ã€æœ‰ hashtagã€å¸å¼•äººã€‚' }) });
                const data = await res.json().catch(() => ({}));
                out.textContent = !res.ok ? (data.reply || 'è«‹æ±‚å¤±æ•—') : (data.reply || 'ç„¡å›è¦†');
            } catch (e) { out.textContent = 'éŒ¯èª¤ï¼š' + e.message; }
        }

        // ç¤¾ç¾¤å°ç·¨ï¼šç”Ÿæˆé…åœ–
        async function communityImage() {
            const prompt = document.getElementById('communityImagePrompt')?.value?.trim() || 'ç¤¾ç¾¤è²¼æ–‡é…åœ–ï¼Œç°¡æ½”ç¾ä»£é¢¨æ ¼';
            const out = document.getElementById('communityOutput');
            out.textContent = 'ç”Ÿæˆåœ–ç‰‡ä¸­â€¦';
            try {
                const res = await fetch('/api/image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, model: 'dall-e-3', size: '1024x1024' }) });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) { out.textContent = data.error || 'ç”Ÿæˆå¤±æ•—'; return; }
                out.innerHTML = '<img src="' + escapeHtml(data.url) + '" alt="Generated" class="max-w-full rounded-lg shadow">';
            } catch (e) { out.textContent = 'éŒ¯èª¤ï¼š' + e.message; }
        }

        // ç¤¾ç¾¤å°ç·¨ï¼šç†±é–€è©±é¡Œ
        async function communityTrending() {
            const out = document.getElementById('communityOutput');
            out.textContent = 'æœå°‹ç†±é–€è¶¨å‹¢ä¸­â€¦';
            try {
                const res = await fetch('/api/search', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: 'ç†±é–€ è¶¨å‹¢ ä»Šæ—¥' }) });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) { out.textContent = data.error || 'æœå°‹å¤±æ•—'; return; }
                const list = (data.results || []).slice(0, 8).map((r, i) => (i + 1) + '. ' + r.title + '\n   ' + (r.snippet || '')).join('\n\n');
                out.textContent = list || 'ç„¡çµæœï¼Œå¯æ”¹åœ¨ã€Œç¶²çµ¡æœç´¢ã€é è¼¸å…¥æ›´å…·é«”é—œéµå­—ã€‚';
            } catch (e) { out.textContent = 'éŒ¯èª¤ï¼š' + e.message; }
        }

        // åˆå§‹åŒ–
        loadSettings();
    </script>
</body>
</html>
